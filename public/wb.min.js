"use strict";function setupCanvasSize(e){var t=e.offsetWidth-25;t>980&&(t=980);var s=Math.round(t/16*9,2);canvassize.top=0,canvassize.left=0,canvassize.height=s,canvassize.width=t,canvassize.bottom=canvassize.top+s,canvassize.right=canvassize.left+t}function initialize(){$messages=$("#messages"),$msg=$("#msg"),window.onunload=disconnectMe,setupCanvas(),setupSockets(),setupUIEvents()}function setupSockets(){socket=io(),socket.on("connect",connectToServer),socket.on("settings",updateSettings),socket.on("chat",appendChatMsg),socket.on("draw",draw),socket.on("image",addImageToCanvas),socket.on("text",addText),socket.on("update",addUpdate),socket.on("refreshWB",refreshWB),socket.on("id",function(e){availableId=e}),socket.on("erase",function(){canvas.clear()})}function setActiveMenuItem(e){var t=$(e.delegateTarget),s=($("#erasedraw"),$("#wbcontrols .primary li[id]"));s.removeClass("selected"),t.addClass("selected").addClass("animated")}function setupUIEvents(){$(".primary li:not(.empty)").on("click",setActiveMenuItem).on("transitionend",function(){$(this).removeClass("animated")}),$("#edit").on("click",function(){var e=$(this),t=!canvas.isDrawingMode;canvas.isDrawingMode=t,t?e.addClass("selected"):e.removeClass("selected")}),$("#color").spectrum({color:"#000",showButtons:!1,preferredFormat:"rgb",hideAfterPaletteSelect:!0,showPaletteOnly:!1,showPalette:!0,palette:[["black","darkgray","gray","lightgray","white"],["blue","green","red","purple","brown"],["lightblue","lightgreen","pink","violet","orange"],["rgb(225,26,43)","rgb(164,18,20)","rgb(89,44,130)"]],change:function(e){parseInt(e._r,10),parseInt(e._g,10),parseInt(e._b,10);canvas.freeDrawingBrush.color=e.toHexString(),settings.text.color=e.toHexString()}}),$("#range").on("change",function(){var e=$(this).val();e=parseInt(e,10),canvas.freeDrawingBrush.width=e}),$("#undo").on("click",function(){console.log("undo"),$(this).removeClass("selected")}),$("#addImage").on("click",function(){var e=window.prompt("Paste in the URL below.  Local images WILL NOT WORK.");e&&(addImageToCanvas(e),settings.type=settings.config.types.image,settings.image.url=e,settings.image.id=availableId,socket.emit("getID"),socket.emit("send",settings)),$(this).removeClass("selected")}),$("#erase").on("click",function(){var e=$(this);window.setTimeout(function(){var t=confirm("Erase the entire whiteboard for all users?");e.removeClass("selected"),t&&(socket.emit("clear",settings.name),canvas.clear())},200)}),$("#erasedraw").on("click",function(){var e=$(this);settings.draw.isErase=!settings.draw.isErase,settings.draw.isErase?e.addClass("selected"):e.removeClass("selected")}),$("#save").on("click",function(){document.getElementById("canvas").toBlob(function(e){saveAs(e,"whiteboard.png")},"image/png"),$(this).removeClass("selected")}),$("#addText").on("click",function(){settings.type=settings.config.types.text}),$("#send").on("click",sendMsg),$msg.on("keyup",function(e){e.preventDefault(),13===e.which&&sendMsg(readChatMessage())})}function connectToServer(){var e=JSON.parse(localStorage.getItem("whiteboard"))||{name:"",uid:0},t=e.name||getName(),s=e.uid||0;socket.emit("init",{name:t,uid:s}),socket.emit("getID")}function getName(){var e=window.prompt("What is your name?");return e||(e="Anonymous"),e}function updateSettings(e){localStorage.setItem("whiteboard",'{"name":"'+e.name+'", "uid":"'+e.uid+'"}'),settings=e}function appendChatMsg(e){var t="";e.forEach(function(e){var s=e.id===settings.id?"message-you":"message-other";t+=e.message.replace("{{messagetype}}",s)}),$messages=$messages||$("#messages"),$messages.append(t),window.location.href="#wb"}function sendMsg(e){settings.chat.message=e,settings.chat.to=settings.config.users.other,settings.chat.from=settings.id,settings.type=settings.config.types.chat,socket.emit("send",settings)}function readChatMessage(){$msg=$msg||$("#msg");var e=$msg.val();return $msg.val(""),e}function disconnectMe(){socket.emit("removeuser",settings)}function setupCanvas(){canvas=canvas||new fabric.Canvas("canvas",{backgroundColor:"#fff",height:canvassize.height,width:canvassize.width,isDrawingMode:!1}),canvas.freeDrawingBrush=new fabric.PencilBrush(canvas),canvas.freeDrawingBrush.color="#000",canvas.freeDrawingBrush.width=10,canvas.on("path:created",function(e){settings.type=settings.config.types.draw,settings.draw=e,settings.draw.id=availableId,socket.emit("getID"),socket.emit("send",settings)}),canvas.on("object:modified",function(e){settings.type=settings.config.types.update,settings.data=e.target,settings.draw.id=availableId,socket.emit("getID"),socket.emit("send",settings)})}function draw(e){console.log(e);var t=new fabric.Path;t.set(e.path),canvas.add(t),canvas.renderAll()}function refreshWB(e){e.forEach(function(e){draw(e)})}function addImageToCanvas(e){fabric.Image.fromURL(e,function(e){var t=scaleImage(e.height,e.width);e.setHeight(t.h),e.setWidth(t.w),canvas.add(e)},{selectable:!0}),canvas.renderAll()}function scaleImage(e,t){var s={};return e>t?(s.w=parseInt(t/e*200,10),s.h=200):(s.h=parseInt(e/t*200),s.w=200),s}function addText(e){var t=new fabric.Text(e.text.msg,{left:e.text.x||5,top:e.text.y||5,stroke:e.text.color,selectable:!0,id:e.text.id});canvas.add(t),settings.type=settings.config.types.chat}function addUpdate(e){console.log(e)}var socket,settings,$messages,$msg,drawings=[],canvas,availableId,canvassize={top:0,bottom:0,left:0,right:0,height:0,width:0};$(function(){initialize()}),setupCanvasSize(document.getElementById("whiteboard"));